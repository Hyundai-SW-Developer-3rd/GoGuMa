<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ggm.goguma.mapper.ReviewMapper">

	<!-- 상품평 목록 -->
	<select id="getReviewList" parameterType="long" resultType="com.ggm.goguma.dto.ReviewDTO">
		SELECT A.name, A.reviewid, B.productname, A.productid, B.parentpid AS parentid, A.content, A.createdate
        FROM (SELECT m.name, r.reviewid, r.productid, r.content, r.createdate
                FROM review r, member m
                WHERE r.memberid = m.memberid) A, product B
        WHERE B.productid = A.productid
        AND B.parentpid = #{productID}
        ORDER BY A.createdate DESC
	</select>
	
	<!-- 회원이 상품의 상품평을 작성한 적이 있는지 확인
		 'resultType < 1' 인 경우 상품평 작성 가능 -->
	<select id="isExistReview" resultType="long">
		SELECT COUNT(*) AS cnt
        FROM (SELECT r.productid, m.memberid
                FROM review r, member m
                WHERE r.memberid = m.memberid) A, product B
        WHERE B.productid = A.productid
        AND B.parentpid = #{productID}
        AND A.memberid = #{memberID}
	</select>
	
	<!-- 회원이 상품을 구매 확정한 상태인지 확인
		 'resultType != null' 인 경우 상품평 작성 가능 -->
	<select id="isFinishRcpt" resultType="Integer">
		SELECT A.productid AS productid
		FROM (SELECT o.orderstatus, p.parentpid, o.receiptid, o.productid
			    FROM orderdetail o, product p
			    WHERE p.productid = o.productid
			    AND o.orderstatus = 'F'
			    AND p.parentpid = #{productID}) A, receipt B
		WHERE A.receiptid = B.receiptid
		AND B.memberid = #{memberID}
	</select>
	
	<!-- 상품평 작성 -->
	<insert id="insertReview" useGeneratedKeys="true" keyProperty="reviewID" keyColumn="reviewID">
		INSERT INTO review(productid, memberid, content, prodthumbnail)
		VALUES (#{productID}, #{memberID}, #{content}, #{prodThumbNail})
	</insert>
	
	<!-- 상품평 삭제 -->
	<delete id="deleteReview" parameterType="long">
		DELETE FROM review
		WHERE reviewid = #{reviewID}
	</delete>
	
	<!-- 내가 작성한 상품평 목록 -->
	<select id="getMyReviewList" resultType="com.ggm.goguma.dto.ReviewDTO">
		SELECT C.reviewid, D.productname, C.productname AS optionname, D.productid, C.content, C.createdate, D.categoryid, C.prodthumbnail
		FROM (SELECT A.reviewid, B.productname, B.parentpid AS parentid, A.content, A.createdate, A.prodthumbnail
		        FROM (SELECT *
		                FROM review r, member m
		                WHERE r.memberid = m.memberid
		                AND m.memberid = #{memberID}) A, product B
		        WHERE B.productid = A.productid
		        ORDER BY A.createdate DESC) C, product D 
		WHERE C.parentid = D.productid
	</select>
	
	<!-- 작성 가능한 상품평 -->

</mapper>